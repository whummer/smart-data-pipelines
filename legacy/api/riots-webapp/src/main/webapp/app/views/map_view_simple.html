<section ng-controller="MapController" style="height: 100%;">
	<div id="mapView" style="width: 100%; height: 300px;"></div>
</section>

<script>
app = angular.module("app");
app.controller('MapController', [
	'$scope', '$http', '$compile',
	function($scope, $http, $compile) {

		require(["leaflet"],
		  function (L) {

			L.Icon.Default.imagePath = 'img/markers/';

			var _m = $scope.shared.map = {};
			var currentLocation = null;
			var defaultLocation = [ 48.19742, 16.37127 ];

			_m.render = function() {	

				if(_m.map) {
					// already initialized
					setTimeout(function() {
						_m.map.invalidateSize(false);
					}, 100);
					return;
				}

				initMapsMarkers(L);

				_m.map = L.map("mapView", {
					"maxZoom": 23,
					"__markers": []
				}).
				setView($scope.defaultLocation, 18).
				on("mouseup", function(e) {
					var newLoc = _m.map.getCenter();
					_m.currentLocation = newLoc;
				});
				L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
					maxZoom: 23,
					maxNativeZoom: 19
				}).addTo(_m.map);
			}

			_m.deleteMarker = function (marker) {
				_m.map.removeLayer(marker);
			};

			_m.deleteAllMarkers = function () {
				$.each(_m.map.options.__markers, function(idx,el) {
					_m.deleteMarker(el);
				});
			};

			_m.addMarker = function(m) {
				var marker = L.marker(
					[ m.location ? m.location.latitude : m.lat ? m.lat : m.latitude, 
					  m.location ? m.location.longitude : m.lon ? m.lon : m.longitude], 
					{
						draggable : true,
						title: m.name,
						userdata: m
					}
				).animateDragging().
				bindPopup(m.name).
				on("click", function() {
					$scope.$apply(function(){
						_m.map.selectedThing = m;
					});
				});
				_m.map.addLayer(marker);
				_m.map.options.__markers.push(marker);
				return marker;
			};

			/* render main element */
			_m.render();

		});

	}
]);
</script>