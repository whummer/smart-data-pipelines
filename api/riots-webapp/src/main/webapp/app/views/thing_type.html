<section ng-controller="CatalogViewController" id="devCatalogSection">
  <div class="container" ng-controller="ThingTypesController">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h2 class="panel-title"><span class="glyphicon glyphicon-edit"></span> <b>{{shared.selectedThingType.name}}</b>
        </h2>
      </div>
      <div class="panel-body">
        <section ng-controller="ThingTypeController" id="devTypeSection">
          <tabset>
            <tab heading="General Properties">
              <ng-include src="appConfig['appRootPath'] + '/views/thing_type_details.html'"></ng-include>
            </tab>
            <tab heading="Composite Type">
              <ng-include src="appConfig['appRootPath'] + '/views/thing_type_composite.html'"></ng-include>
            </tab>
            <tab heading="Virtualizable Properties">
              <ng-include src="appConfig['appRootPath'] + '/views/thing_type_props.html'"></ng-include>
            </tab>
          </tabset>

          <div class="form-group" style="display: block; float: left; width: 100%;">
            <div class="text-right">
              <hr/>
              <button class="btn  btn-sm btn-primary" id="btnDevTypeSave">
                <span class="glyphicon glyphicon-ok"></span> Save Changes
              </button>
              <a href="#/catalog" class="btn btn-sm btn-info"><span
                      class="glyphicon glyphicon-remove"></span> Cancel</a>
            </div>
          </div>

        </section>
      </div>
    </div>
  </div>
</section>

<script type="text/javascript">

  var app = angular.module("app");
  app.controller('ThingTypeController', function ($scope, $http, $compile, $routeParams, $log) {
            AppController($scope, $http, $compile);

            if ($routeParams.thingTypeID) {
              invokeGET($http, $scope.thingTypesAPI + "/" + $routeParams.thingTypeID,
                      function (data, status, headers, config) {
                        $log.info("Loading ThingType with ID " + $routeParams.thingTypeID);
                        $scope.shared.selectedThingType = data.result;
                        if (!$scope.shared.selectedThingType['image-urls']) {
                          $scope.shared.selectedThingType['image-urls'] = [];
                        }

                        $log.debug("Adding Thing to shared scope: ", data.result);
                      }
              );
            }

            $scope.saveThingType = function () {
              var thingType = $scope.shared.selectedThingType;
              $scope.applyFeatures();
              $scope.prepareModelValues($scope.shared.selectedThingType);
              thingType = JSON.parse(JSON.stringify(thingType));
              $scope.prepareModelValues(thingType);
              invokePUT($scope.http, $scope.thingTypesAPI,
                      JSON.stringify(thingType),
                      function (data, status, headers, config) {
                        $log.info("Invoked PUT for ThingType ", thingType);
                        $log.debug("Scope.loadAllThingTypes: ", $scope.loadAllThingTypes);
                        $scope.loadAllThingTypes();
                        $log.debug("Reloaded all thing types after saveThingType(). Location: ", $location);
                        $location.path("catalog");
                      }
              );
            };

            $scope.applyFeatures = function () {
              /* apply tags */
              $scope.shared.selectedThingType.tags = $("#devTypeTags").tagsinput('items');
              /* apply features */
              if (!$scope.shared.selectedThingType.features) {
                $scope.shared.selectedThingType.features = {};
              }
            };

            /* register event handlers */
            $scope.addClickHandler("btnDevTypeSave", $scope.saveThingType);
          }
  );

</script>
