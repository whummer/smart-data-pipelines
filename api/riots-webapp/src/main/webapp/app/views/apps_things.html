
<section ng-controller="ThingsController">

  <!-- Thing Table -->
	<div>
		<div id="thingsTable" ui-grid="tableOptions" ui-grid-selection ui-grid-edit ui-grid-row-edit class="grid"></div>
	</div>

  <!-- Add/Delete Thing buttons -->
  <div style="padding-bottom: 15px;">
    <button class="btn btn-primary btn-sm" id="btnAddThing"><span class="glyphicon glyphicon-plus"></span> Add Thing to Application</button>
    <button class="btn btn-warning btn-sm" id="btnDeleteThing"><span class="glyphicon glyphicon-minus"></span> Remove Thing from Application</button>
  </div>

</section>

<script type="text/javascript">

var app = angular.module("app");
app.controller('ThingsController',[
	'$scope', '$http', '$compile',
	function($scope, $http, $compile) {

		AppController($scope, $http, $compile);

		$scope.tableOptions = {};

		var initTable = function() {
			var columnsConfig = [
				{label: "Name", field: "name", sortable: true,
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity.name}}</div>"
				},
				{label: "Type", field: "thing-type", 
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity['thing-type'].name}}</div>"
				}
			];
			$scope.tableOptions.data = [];
			renderUITable($scope.tableOptions, "thingsTable", columnsConfig,
				function(event) {
			    	if(event.type == "dgrid-select") {
			    		$scope.$apply(function() {
			    			$scope.shared.selectedThing = event.rows[0].data;
						});
			    	} else if(event.type == "dgrid-deselect") {
			    		$scope.$apply(function(){
			    			$scope.shared.selectedThing = null;
						});
			    	}
				},
				true
			);
		}
		initTable();

		var loadAllThings = function() {
			var app = $scope.shared.selectedApplication;
			if(!app) return;
			var options = {appId: app.id};
			riots.things(options, function(things) {
				$.each(things, function(idx,el) {
					if(el[THING_TYPE]) {
						el[THING_TYPE] = riots.thingType(el[THING_TYPE], null, API_CACHE_DEFAULT);
					}
				});
				$scope.tableOptions.data = things;
				$scope.shared.listOfThings = things;
				setTimeout(function() {
					setupDragAndDrop();
				}, 100);
			});
		}
		loadAllThings();

		var setupDragAndDrop = function() {
			// set up drag/drop
			var selector = "#thingsTable .ui-grid-row";
			$(selector).draggable({
				helper: function() {
					return $("<div style='z-index: 100000'>" +
							"<img src='img/icon_map_move.png'/></div>");
			    },
			    start: function(event, ui) { $(this).css("z-index", 100000); },
			    cursorAt: { top: 24, left: 25 },
			    appendTo: "body",
			    zIndex: 100000
			});
		}

		var saveAppAndLoadThings = function() {
			var app = clone($scope.shared.selectedApplication);
			delete app["$$hashKey"];
			riots.save.app(app, loadAllThings);
		}

		var addThing = function(){
			item = {
				name: "unnamed"
			}
			$scope.addThingInDB(item, function(thing) {
				$scope.shared.selectedApplication[THINGS].push(thing.id);
				saveAppAndLoadThings();
			});
		}
		var deleteThing = function(){
			var selection = $scope.shared.selectedThing;
			if(!selection || !selection.id) return;
			$scope.deleteThingInDB(selection, function() {
				$scope.shared.selectedThing = null;
				arrayRemove($scope.shared.selectedApplication[THINGS], selection.id);
				saveAppAndLoadThings();
			});
		}

		/* register event handlers*/
		$scope.addClickHandler("btnAddThing", addThing);
		$scope.addClickHandler("btnDeleteThing", deleteThing);

	}]
);

</script>
