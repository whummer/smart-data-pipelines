
<section ng-controller="ThingsController">

  <!-- Thing Table -->
	<div>
		<div id="assetsTable" ui-grid="tableOptions" ui-grid-selection ui-grid-edit ui-grid-row-edit class="grid"></div>
	</div>

  <!-- Add/Delete Thing buttons -->
  <div style="padding-bottom: 15px;">
    <button class="btn btn-primary btn-sm" id="btnAddAsset"><span class="glyphicon glyphicon-plus"></span> Add Thing to Application</button>
    <button class="btn btn-warning btn-sm" id="btnDeleteAsset"><span class="glyphicon glyphicon-minus"></span> Remove Thing from Application</button>
  </div>

</section>

<script type="text/javascript">

var app = angular.module("app");
app.controller('ThingsController',[
	'$scope', '$http', '$compile',
	function($scope, $http, $compile) {

		AppController($scope, $http, $compile);

		$scope.tableOptions = {};

		$scope.initTable = function() {
			var columnsConfig = [
				{label: "Name", field: "name", sortable: true,
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity.name}}</div>"
				},
				{label: "Type", field: "thing-type", 
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity['thing-type'].name}}</div>"
				},
				//{label: "Position", field: "location", 
				//	cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity.formatCoords()}}</div>"
				//},
				//{label: "Tags", field: "tags"}
			];
			$scope.tableOptions.data = [];
			renderUITable($scope.tableOptions, "assetsTable", columnsConfig,
				function(event) {
			    	if(event.type == "dgrid-select") {
			    		$scope.$apply(function() {
			    			$scope.shared.selectedThing = event.rows[0].data;
						});
			    	} else if(event.type == "dgrid-deselect") {
			    		$scope.$apply(function(){
			    			$scope.shared.selectedThing = null;
						});
			    	}
				},
				true
			);
		}
		$scope.initTable();

		$scope.loadAllAssets = function() {
			invokeGET($scope.http, $scope.thingsAPI + "?page=0&size=" + 100,
				function(data, status, headers, config) {
					$.each(data.result, function(idx,el) {
						el.formatCoords = function() {
							return $scope.formatCoords(el.location);
						}
						if(el["thing-type"]) {
							el["thing-type"] = shared.thingType(el["thing-type"]);
						}
					});
					$scope.tableOptions.data = data.result;
					$scope.shared.listOfThings = data.result;
					setTimeout(function() {
						setupDragAndDrop();
					}, 100);
				}
			);
		}
		$scope.loadAllAssets();

		var setupDragAndDrop = function() {
			// set up drag/drop
			var selector = "#assetsTable .ui-grid-row";
			$(selector).draggable({
				helper: function() {
					return $("<div style='z-index: 100000'>" +
							"<img src='img/icon_map_move.png'/></div>");
			    },
			    start: function(event, ui) { $(this).css("z-index", 100000); },
			    cursorAt: { top: 24, left: 25 },
			    appendTo: "body",
			    zIndex: 100000
			});
		}

		$scope.saveAsset = function(item){
			invokePUT($scope.http, $scope.thingsAPI + "/",
				JSON.stringify(item),
				function(data, status, headers, config) {
					$scope.loadAllAssets();
				}
			);
		}
		$scope.addThing = function(){
			item = {
				name: "unnamed"
			}
			$scope.addThingInDB(item, function(asset) {
				//$scope.loadAllAssets();
				eventBus.publish("addOrDel.Asset", asset);
			});
		}
		$scope.deleteThing = function(){
			var selection = $scope.shared.selectedThing;
			if(!selection || !selection.id) return;
			$scope.deleteThingInDB(selection, function() {
				//$scope.loadAllAssets();
				eventBus.publish("addOrDel.Asset", selection);
				$scope.shared.selectedThing = null;
			});
		}

		/* register event handlers*/
		$scope.addClickHandler("btnAddAsset", $scope.addThing);
		$scope.addClickHandler("btnDeleteAsset", $scope.deleteThing);
		$scope.subscribeOnce("addOrDel.Asset", function() {
			$scope.loadAllAssets();
		}, "addOrDel.Asset.worldAssetsView");

	}]
);

</script>
