
<section ng-controller="ThingsController">

  <!-- Thing Table -->
	<div>
		<div id="assetsTable" ui-grid="tableOptions" ui-grid-selection ui-grid-edit ui-grid-row-edit class="grid"></div>
	</div>

  <!-- Add/Delete Thing buttons -->
  <div style="padding-bottom: 15px;">
    <button class="btn btn-primary btn-sm" id="btnAddAsset"><span class="glyphicon glyphicon-plus"></span> Add Thing to Application</button>
    <button class="btn btn-warning btn-sm" id="btnDeleteAsset"><span class="glyphicon glyphicon-minus"></span> Remove Thing from Application</button>
  </div>

</section>

<script type="text/javascript">

var app = angular.module("app");
app.controller('ThingsController',[
	'$scope', '$http', '$compile',
	function($scope, $http, $compile) {

		AppController($scope, $http, $compile);

		$scope.tableOptions = {};

		var initTable = function() {
			var columnsConfig = [
				{label: "Name", field: "name", sortable: true,
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity.name}}</div>"
				},
				{label: "Type", field: "thing-type", 
					cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity['thing-type'].name}}</div>"
				}
			];
			$scope.tableOptions.data = [];
			renderUITable($scope.tableOptions, "assetsTable", columnsConfig,
				function(event) {
			    	if(event.type == "dgrid-select") {
			    		$scope.$apply(function() {
			    			$scope.shared.selectedThing = event.rows[0].data;
						});
			    	} else if(event.type == "dgrid-deselect") {
			    		$scope.$apply(function(){
			    			$scope.shared.selectedThing = null;
						});
			    	}
				},
				true
			);
		}
		initTable();

		var loadAllThings = function() {
			riots.things(function(things) {
				$.each(things, function(idx,el) {
					el.formatCoords = function() {
						return $scope.formatCoords(el.location);
					}
					if(el["thing-type"]) {
						el["thing-type"] = riots.thingType(el["thing-type"], null, API_CACHE_DEFAULT);
					}
				});
				$scope.tableOptions.data = things;
				$scope.shared.listOfThings = things;
				setTimeout(function() {
					setupDragAndDrop();
				}, 100);
			});
		}
		loadAllThings();

		var setupDragAndDrop = function() {
			// set up drag/drop
			var selector = "#assetsTable .ui-grid-row";
			$(selector).draggable({
				helper: function() {
					return $("<div style='z-index: 100000'>" +
							"<img src='img/icon_map_move.png'/></div>");
			    },
			    start: function(event, ui) { $(this).css("z-index", 100000); },
			    cursorAt: { top: 24, left: 25 },
			    appendTo: "body",
			    zIndex: 100000
			});
		}

		var addThing = function(){
			item = {
				name: "unnamed"
			}
			$scope.addThingInDB(item, function(asset) {
				eventBus.publish("addOrDel.Asset", asset);
			});
		}
		var deleteThing = function(){
			var selection = $scope.shared.selectedThing;
			if(!selection || !selection.id) return;
			$scope.deleteThingInDB(selection, function() {
				eventBus.publish("addOrDel.Asset", selection);
				$scope.shared.selectedThing = null;
			});
		}

		/* register event handlers*/
		$scope.addClickHandler("btnAddAsset", addThing);
		$scope.addClickHandler("btnDeleteAsset", deleteThing);
		$scope.subscribeOnce("addOrDel.Asset", function() {
			loadAllThings();
		}, "addOrDel.Asset.worldAssetsView");

	}]
);

</script>
