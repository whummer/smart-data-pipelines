<section ng-controller="TriggersController">
	<div>
		<div style="padding-bottom: 15px;">
			<button class="btn btn-default btn-sm" id="btnAddTrigger">Add</button>
			<button class="btn btn-default btn-sm" id="btnDeleteTrigger">Delete</button>
		</div>
		<div id="funcsTable" ui-grid="tableOptions" ui-grid-selection ui-grid-edit ui-grid-row-edit class="grid"></div>
	</div>
	<div ng-show="shared.selectedTrigger">
		<!-- TODO -->
	</div>
</section>
<style type="text/css">
#funcsTable {
	height: 150px;
}
</style>
<script type="text/javascript">

	var app = angular.module("app");
	app.controller('TriggersController',[
		'$scope', '$http', '$compile',
		function($scope, $http, $compile) {

			AppController($scope, $http, $compile);

			$scope.tableOptions = {};

			var initTable = function() {
				var columnsConfig = [
					{label: "ID", field: "id", sortable: true},
					{label: "Type", field: "type", sortable: true},
					{label: "Creation Date", field: CREATION_DATE, sortable: true, cellTemplate:
						"<div class='ui-grid-cell-contents'>{{row.entity.timeCreated()}}</div>"
					}
				];
				$scope.tableOptions.data = [];
				renderUITable($scope.tableOptions, "funcsTable", columnsConfig,
					function(event) {
				    	if(event.type == "dgrid-select") {
				    		$scope.$apply(function() {
				    			$scope.shared.selectedTrigger = event.rows[0].data;
							});
				    	} else if(event.type == "dgrid-deselect") {
				    		$scope.$apply(function(){
				    			$scope.shared.selectedTrigger = null;
							});
				    	}
					}, true
				);
			}

			var loadAllTriggers = function() {
				$scope.tableOptions.data = [];
				invokeGET($scope.http, $scope.triggersAPI,
						function(data, status, headers, config) {
							$.each(data.result, function(idx,el) {
								el.timeCreated = function() {
									return formatDate(el[CREATION_DATE]);
								};
								$scope.tableOptions.data.push(el);
							});
						}
					);
			}

			loadAllTriggers();

			var addTrigger = function(){
				item = {
					name: "unnamed",
					type: "UNDEFINED"
				}
				riots.add.trigger(item, function(asset) {
					loadAllTriggers();
				});
			}
			var deleteTrigger = function() {
				var selection = $scope.shared.selectedTrigger;
				if(!selection || !selection.id) return;
				riots.delete.trigger(selection, function() {
					loadAllTriggers();
					$scope.shared.selectedTrigger = null;
				});
			}

			/* register event handlers*/
			$scope.addClickHandler("btnAddTrigger", addTrigger);
			$scope.addClickHandler("btnDeleteTrigger", deleteTrigger);

			/* load the main elements */
			initTable();

		}]
	);

</script>
