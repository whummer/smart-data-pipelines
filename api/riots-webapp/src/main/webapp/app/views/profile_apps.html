<section ng-controller="AppsController" id="devCatalogSection">
    <div>
    	
        <div style="margin-bottom: 10px;" class="text-right">
            <button class="btn btn-primary btn-sm" id="btnAddApp">
                <span class="glyphicon glyphicon-plus"></span> Add New Application
            </button>
            <button class="btn btn-warning btn-sm" id="btnDeleteApp"><span
                    class="glyphicon glyphicon-minus"></span> Delete Application
            </button>
        </div>

        <!-- table view for apps -->
        <div id="AppsTable" ui-grid="gridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
             class="grid"></div>

        <div ng-show="selectedApp">

            <form class="form-horizontal" role="form" style="text-align: left">

                <!-- app name -->
                <div class="form-group">
                    <label for="inputAppName" class="col-sm-3 control-label">Application Name</label>
                    <div class="col-sm-9">
                        <input id="inputAppName" class="form-control input-sm" ng-model="selectedApp.name"/>
                    </div>
                </div>

                <!-- app key -->
                <div class="form-group">
                    <label for="inputAppKey" class="col-sm-3 control-label">Application Key</label>
                    <div class="col-sm-9">
                        <input id="inputAppKey" class="form-control input-sm" ng-model="selectedApp.appKey" disabled="disabled"/>
                    </div>
                </div>

                <!-- JS -->
                <div class="form-group">
                    <label for="propName" class="col-sm-3 control-label">JavaScript Code</label>
                    <div class="col-sm-9">
<pre>window.RIOTS_USER_ID = "{{userInfo.id}}"
window.RIOTS_APP_KEY = "{{selectedApp.appKey}}"</pre>
                    </div>
                </div>

                <!-- save -->
                <div class="form-group">
                    <label for="propName" class="col-sm-3 control-label"></label>
                    <div class="col-sm-9">
			            <button class="btn btn-primary btn-sm" id="btnSaveApp">Save Changes</button>
                    </div>
                </div>

       		</form>
    	</div>
    </div>
</section>
<style type="text/css">
#AppsTable {
	height: 150px;
}
</style>
<script type="text/javascript">

var app = angular.module("app");
app.controller('AppsController', function ($scope, $http, $compile, $routeParams, $log) {
    AppController($scope, $http, $compile);

    $scope.selectedApp = null;
    $scope.gridConfig = {};

    var initAppTable = function () {
        var columnsConfig = [
            {label: "Name", field: "name", sortable: true},
            {label: "Creation Date", field: "created"},
            {label: "App Key", field: "appKey"}
        ];
        $scope.gridConfig.data = [];
        renderUITable($scope.gridConfig, "AppsTable", columnsConfig,
	        function (event) {
	            if (event.type == "dgrid-select") {
	                $scope.$apply(function () {
	                    $scope.selectedApp = event.rows[0].data;
	                });
	            } else if (event.type == "dgrid-deselect") {
	                $scope.$apply(function () {
	                    $scope.selectedApp = null;
	                });
	            }
	        }
        );
    };

	var buildAppTable = function(apps) {
		$scope.gridConfig.data = apps;
	}

    var loadAppTable = function () {
    	riots.apps(function(apps) {
    		console.log("buildAppTable", apps);
    		buildAppTable(apps);
    	});
    };

    var addApp = function () {
    	var newApp = {name: "New Application"};
    	riots.add.app(newApp, function(newApp) {
    		loadAppTable();
    	});
    };
    var deleteApp = function () {
    	riots.delete.app($scope.selectedApp, function(newApp) {
    		loadAppTable();
    	});
    };
    var saveApp = function () {
    	var app = clone($scope.selectedApp);
    	delete app["$$hashKey"];
    	riots.save.app(app);
    };

	/* add event listeners */
    $scope.addClickHandler("btnAddApp", addApp);
    $scope.addClickHandler("btnDeleteApp", deleteApp);
    $scope.addClickHandler("btnSaveApp", saveApp);

	/* render main elements */
    initAppTable();
    loadAppTable();

});

</script>
