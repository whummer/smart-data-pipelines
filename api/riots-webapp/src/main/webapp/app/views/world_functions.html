<section ng-controller="FuncsController">
	<div>
		<div style="padding-bottom: 15px;">
			<button class="btn btn-default btn-sm" id="btnAddFunc">Add</button>
			<button class="btn btn-default btn-sm" id="btnDeleteFunc">Delete</button>
		</div>
		<div id="funcsTable" ui-grid="tableOptions" ui-grid-selection ui-grid-edit ui-grid-row-edit class="grid"></div>
	</div>
	<div ng-show="selectedFunc">
		<!-- TODO -->
	</div>
</section>
<style type="text/css">
#funcsTable {
	height: 150px;
}
</style>
<script type="text/javascript">

	var app = angular.module("app");
	app.controller('FuncsController',[
		'$scope', '$http', '$compile',
		function($scope, $http, $compile) {

			AppController($scope, $http, $compile);

			$scope.tableOptions = {};

			$scope.initTable = function() {
				var columnsConfig = [
					{label: "ID", field: "id", sortable: true},
					{label: "Type", field: "type", sortable: true},
					{label: "Creation Date", field: "created", sortable: true, cellTemplate: 
						"<div class='ui-grid-cell-contents'>{{row.entity.timeCreated()}}</div>"
					}
				];
				$scope.tableOptions.data = [];
				renderUITable($scope.tableOptions, "funcsTable", columnsConfig,
					function(event) {
				    	if(event.type == "dgrid-select") {
				    		$scope.$apply(function() {
				    			$scope.selectedFunc = event.rows[0].data;
							});
				    	} else if(event.type == "dgrid-deselect") {
				    		$scope.$apply(function(){
				    			$scope.selectedFunc = null;
							});
				    	}
					}, true
				);
			}
			$scope.initTable();

			$scope.loadAllFuncs = function() {
				$scope.tableOptions.data = [];
				$scope.loadGeoFences();
			}

			$scope.loadGeoFences = function() {
				invokeGET($scope.http, $scope.utilsAPI + "/geo/fence",
					function(data, status, headers, config) {
						$.each(data.result, function(idx,el) {
							el.type = "Geo Fence";
							el.timeCreated = function() {
								return formatDate(el.created);
							}
							$scope.tableOptions.data.push(el);
						});
					}
				);
			}
			$scope.loadAllFuncs();

			$scope.saveFunc = function(item){
				invokePUT($scope.http, $scope.thingsAPI + "/",
					JSON.stringify(item),
					function(data, status, headers, config) {
						$scope.loadAllFuncs();
					}
				);
			}
			$scope.addFunc = function(){
				item = {
					name: "unnamed"
				}
				$scope.addFuncInDB(item, function(asset) {
					$scope.loadAllFuncs();
				});
			}
			$scope.deleteFunc = function(){
				var selection = $scope.selectedFunc;
				if(!selection || !selection.id) return;
				$scope.deleteFuncInDB(selection, function() {
					$scope.loadAllFuncs();
					$scope.selectedFunc = null;
				});
			}

			/* register event handlers*/
			$scope.addClickHandler("btnAddFunc", $scope.addFunc);
			$scope.addClickHandler("btnDeleteFunc", $scope.deleteFunc);

		}]
	);

</script>
