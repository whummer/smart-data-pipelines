<section ng-controller="ThingTypePropsController" id="thingPropsSection">

	<div ng-show="shared.selectedThingType">

		<h3>Inherited Properties</h3>
		<!-- table view for inherited properties -->
		<div id="propsInheritedTable" ui-grid="subGridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
			 class="grid"></div>

		<h3>Properties</h3>
		<div style="margin-bottom: 10px;" class="text-right">
			<button class="btn btn-primary btn-sm" id="btnThingTypePropAdd">
				<span class="glyphicon glyphicon-plus"></span> Add New Property
			</button>
			<button class="btn btn-warning btn-sm" id="btnThingTypePropDelete"><span
					class="glyphicon glyphicon-minus"></span> Delete Property
			</button>
		</div>

		<!-- table view for thing properties -->
		<div id="propsTable" ui-grid="gridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
			 class="grid"></div>

		<div ng-show="selectedProperty">

			<form class="form-horizontal" role="form" style="text-align: left">

				<!-- property name -->
				<div class="form-group">
					<label for="propName" class="col-sm-3 control-label">Property Name</label>

					<div class="col-sm-9">
						<input id="propName" class="form-control input-sm" ng-model="selectedProperty.name"/>
					</div>
				</div>

				<!-- value type -->
				<div class="form-group">
					<label for="selBaseType" class="col-sm-3 control-label">Value Type</label>

					<div class="col-sm-9">
						<select id="selBaseType" class="form-control input-sm"
								ng-model="selectedProperty[PROPERTY_TYPE]">
							<option value="BOOLEAN">BOOLEAN</option>
							<option value="STRING">STRING</option>
							<option value="DOUBLE">DOUBLE</option>
							<option value="LONG">LONG</option>
							<option value="LIST">LIST</option>
						</select>
					</div>
				</div>

				<!-- parent property -->
				<div class="form-group">
					<label for="selParentProp" class="col-sm-3 control-label">Parent Property</label>

					<div class="col-sm-9">
						<select id="selParentProp" class="form-control input-sm"
								ng-options="opt.name for opt in parentProps track by opt.id"
								ng-model="selectedProperty.parentProp">
						</select>
					</div>
				</div>

				<!-- value domain (e.g. discrete) for this property -->
				<div class="form-group" ng-show="selectedProperty[PROPERTY_TYPE] != 'LIST'">
					<label for="selDomainType" class="col-sm-3 control-label">Value Domain</label>

					<div class="col-sm-9">
						<select id="selDomainType" class="form-control input-sm"
								ng-model="selectedProperty.valueDomain.type">
							<option value="">None (Default)</option>
							<option value="Continuous" ng-if="selectedProperty[PROPERTY_TYPE] == 'LONG' || selectedProperty[PROPERTY_TYPE] == 'DOUBLE'">Continuous (min/max)</option>
							<option value="Discrete" ng-if="selectedProperty[PROPERTY_TYPE] == 'LONG' || selectedProperty[PROPERTY_TYPE] == 'DOUBLE'">Discrete (min/max/steps)</option>
							<option value="Enumerated">Enumeration (values)</option>
						</select>
					</div>
				</div>

				<div ng-show="selectedProperty[PROPERTY_TYPE]">

					<!-- enumerated values -->
					<div class="form-group" 
							ng-show="selectedProperty[PROPERTY_TYPE] != 'LIST' && selectedProperty.valueDomain.type == 'Enumerated'">
						<label for="selDomainType" class="col-sm-3 control-label">Values</label>
	
						<div class="col-sm-9">
							<table>
								<tr ng-repeat="n in range(0, selectedProperty.valueDomain.values.length - 1)">
									<td><input class="domPropValue form-control input-sm"
											   ng-model="selectedProperty.valueDomain.values[n]"/></td>
								</tr>
							</table>
							<button class="btn btn-default btn-sm" id="btnThingTypePropAddValue">Add Value</button>
						</div>
					</div>
	
					<!-- enumerated values -->
					<div class="form-group" 
							ng-show="(selectedProperty[PROPERTY_TYPE] == 'LONG' || selectedProperty[PROPERTY_TYPE] == 'DOUBLE') && 
							(selectedProperty.valueDomain.type == 'Discrete' || selectedProperty.valueDomain.type == 'Continuous')">
						<label for="selDomainType" class="col-sm-3 control-label">Min. / Max. Values</label>
	
						<div class="col-sm-9">
							<input id="propMinVal" class="form-control input-sm"
								   ng-model="selectedProperty.valueDomain.min" style="width: 30%"/> /
							<input id="propMaxVal" class="form-control input-sm"
								   ng-model="selectedProperty.valueDomain.max" style="width: 30%"/>
						</div>
					</div>
	
					<!-- step increment -->
					<div class="form-group" 
							ng-show="(selectedProperty[PROPERTY_TYPE] == 'LONG' || selectedProperty[PROPERTY_TYPE] == 'DOUBLE') && selectedProperty.valueDomain.type == 'Discrete'">
						<label for="selDomainType" class="col-sm-3 control-label">Step Increment</label>
	
						<div class="col-sm-9">
							<input id="propStepVal" class="form-control input-sm"
								   data-ng-model="selectedProperty.valueDomain.step"/>
						</div>
					</div>
					
				</div>

			</form>

		</div>
	</div>

</section>

<style>
	#propsTable {
		height: 200px;
		width: 99%;
	}
	#propsInheritedTable {
		height: 120px;
		width: 99%;
	}
</style>

<script type="text/javascript">
var app = angular.module("app");
app.controller('ThingTypePropsController', 
	function ($scope, $http, $compile, $log) {

		AppController($scope, $http, $compile);

		$scope.selectedProperty = null;
		$scope.gridConfig = {};
		$scope.subGridConfig = {};
		$scope.PROPERTY_TYPE = PROPERTY_TYPE;
		$scope.parentProps = [];

		var initPropsTable = function () {
			var columnsConfig = [
				{label: "Name", field: "displayName", sortable: true},
				{label: "Data Type", field: PROPERTY_TYPE},
				{label: "Value Domain Type", field: "valueDomain.type"}
			];
			$scope.gridConfig.data = [];
			renderUITable($scope.gridConfig, "propsTable", columnsConfig,
				function (event) {
					if (event.type == "dgrid-select") {
						$scope.$apply(function () {
							$scope.selectedProperty = event.rows[0].data;
						});

						buildParentPropsSelect();
						eventBus.publish("select.ThingTypeProps", $scope.selectedProperty);
					} else if (event.type == "dgrid-deselect") {
						$scope.$apply(function () {
							$scope.selectedProperty = null;
						});
						eventBus.publish("select.ThingTypeProps", $scope.selectedProperty);
					} else if (event.type == "dgrid-datachange") {
						var data = event.grid.row(event).data;
						data[event.cell.column.field] = event.value;
						$scope.saveThingType();
					}

					/* adjust UI elements */
					eventBus.publish("change.SelectedProperty");
				}
			);
		};

		var initInheritedPropsTable = function () {
			var columnsConfig = [
				{label: "Name", field: "name", sortable: true},
				{label: "Thing Type", field: "thingType.name"},
				{label: "Data Type", field: PROPERTY_TYPE},
				{label: "Value Domain Type", field: "valueDomain.type"}
			];
			$scope.subGridConfig.data = [];
			renderUITable($scope.subGridConfig, "propsInheritedTable", columnsConfig);
		};

		initPropsTable();
		initInheritedPropsTable();

		var buildPropsTable = function (thingType) {
			if (!thingType.properties) {
				thingType.properties = [];
	   		}
			$.each(thingType.properties, function (idx, el) {
				expandChildProps(el, null, thingType.properties);
			});
			$scope.gridConfig.data = thingType.properties;
		};

		var buildInheritedPropsTable = function () {
			var thingType = $scope.shared.selectedThingType;
			if(!thingType) return;
			$scope.subGridConfig.data = [];
			riots.properties(thingType.id, function(propsList,subThingType) {
				if(thingType.id != subThingType.id) {
					$.each(propsList, function(idx,prop) {
						prop.thingType = subThingType;
						$scope.subGridConfig.data.push(prop);
					});
				}
			});
		};

		var expandChildProps = function (prop, parent, propsList) {
			prop.displayName = (parent ? (parent.displayName + ".") : "") + prop.name;
			if (!prop.children) {
				return;
			}

			$.each(prop.children, function (idx, el) {
				propsList.push(el);
				el.parentProp = prop;
				expandChildProps(el, prop, propsList);
			});

			prop.children = [];
		};

		var buildParentPropsSelect = function (thingType) {
			if (!thingType) {
				thingType = $scope.shared.selectedThingType;
			}

			if (thingType.properties) {

				var propsList = [];
				propsList.push({id: -1, name: "ROOT"});
				$.each(thingType.properties, function (idx, el) {
					if (el[PROPERTY_TYPE] == "LIST") {
						propsList.push({id: el.id, name: el.name});
					}
				});

				renderUISelectValues("selParentProp", propsList);
			}

		};

		var unselectProperty = function () {
			$scope.$apply(function () {
				$scope.selectedProperty = null;
			});
			eventBus.publish("change.SelectedProperty");
		};

		var deleteThingTypeProp = function () {
			var selection = $scope.selectedProperty;
			if (!selection) return;

			arrayRemove($scope.shared.selectedThingType.properties, selection);
			unselectProperty();
		};

		var addThingTypeProp = function () {
			var thingType = $scope.shared.selectedThingType;
			if (!thingType) {
				return;
			}

			var newProp = {};
			newProp[NAME] = "unnamed";
			newProp[PROPERTY_TYPE] = "STRING";

			thingType.properties.push(newProp);
			expandChildProps(newProp, null, thingType.properties);
			unselectProperty();
		};

		var addPropDomainValue = function () {
			if (!$scope.selectedProperty.valueDomain.values)
				$scope.selectedProperty.valueDomain.values = [];

			$scope.$apply(function () {
				$scope.selectedProperty.valueDomain.values.push("");
			});
		};

		/* register event handlers*/
		$scope.addClickHandler("btnThingTypePropAdd", addThingTypeProp);
		$scope.addClickHandler("btnThingTypePropDelete", deleteThingTypeProp);
		$scope.addClickHandler("btnThingTypePropAddValue", addPropDomainValue);
		$scope.$watch("selectedProperty", function() {
			$scope.parentProps = [];
			if($scope.selectedProperty) {
				$.each($scope.gridConfig.data, function(idx,el) {
					if(el != $scope.selectedProperty) {
						$scope.parentProps.push(el);
					}
				});
			}
			$("#btnThingTypePropDelete").attr("disabled",
							$scope.selectedProperty == null);
		});

		$scope.$watch("shared.selectedThingType.children", function () {
			buildInheritedPropsTable();
		});

		$scope.$watch("shared.selectedThingType", function () {
			var thingType = $scope.shared.selectedThingType;
			$log.debug("Watching ThingType for property changes: ", thingType);
			if (!thingType) {
				$scope.selectedProperty = null;
			} else {
				buildPropsTable(thingType);
				buildParentPropsSelect(thingType);
			}
			eventBus.publish("change.SelectedProperty");
		});

		/* start rendering the main elements */
		var thingType = $scope.shared.selectedThingType;
		if(thingType) {
			buildPropsTable(thingType);
			buildParentPropsSelect(thingType);
		}
	}
);

</script>
