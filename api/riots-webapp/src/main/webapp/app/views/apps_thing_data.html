<section ng-controller="ThingDataController" style="height: 100%">

  <div class="alert alert-warning alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    In this view, you can check the data that your configured and selected thing produces. Chose a data entry below and select a visualization type to get started.
  </div>

  <div ng-show="shared.selectedThing">
    <div id="ThingPropsTable" ui-grid="propsGridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
         class="grid"></div>

    <div ng-if="selectedProperty">
      <form class="form-inline">

        <div class="form-group">
          <div class="input-group">
            <div class="input-group-addon input-sm">Datapoints:</div>
            <input id="dataPoints" placeholder="Number of data points" class="form-control input-sm" ng-model="dataOptions.numPoints"/>
            <span class="input-group-btn">
              <button ng-click="displayPropertyData()" class="btn btn-primary input-sm">Update</button>
            </span>

          </div>
        </div>
        <div class="form-group">

        </div>
        <div class="form-group">
          <select ng-model="dataOptions.visType" class="form-control input-sm">
            <option value="none">Select Visualization</option>
            <option value="table">Table</option>
            <option value="chart">Chart</option>
            <option value="map">Map</option>
          </select>
        </div>
        <div class="checkbox ">
          <label>
            <input type="checkbox" id="trackLiveData" ng-model="dataOptions.trackLive"/> Track Live Data
          </label>
        </div>
        <div style="margin-top: 15px">
          <div id="PropsDataTable" ng-show="dataOptions.visType=='table'" ui-grid="dataGridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
               ui-grid-cellnav class="grid"></div>

          <div ng-show="dataOptions.visType == 'chart'" style="overflow: auto;">
            <canvas id="chart1" width="400" height="400"></canvas>
            <br class="clear"/>
          </div>
          <div ng-show="dataOptions.visType == 'map'">
            <ng-include src="appConfig['appRootPath'] + '/views/world_map.html'"></ng-include>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
<style type="text/css">
#ThingPropsTable, #PropsDataTable {
	height: 200px;
}
</style>
  <script type="text/javascript">

    var app = angular.module("app");
    app.controller('ThingDataController', [
      '$scope', '$http', '$compile', '$routeParams',
      function ($scope, $http, $compile, $routeParams) {

        AppController($scope, $http, $compile);

        $scope.thingID = $routeParams.thingID;
        $scope.propsGridConfig = {};
        $scope.dataGridConfig = {};
        var defaultNumPoints = 50;
        $scope.dataOptions = {
          trackLive: false,
          numPoints: defaultNumPoints,
          visType: "none"
        }

        var initTables = function () {
          var propsGridColumns = [
            {label: "Property", field: "name", sortable: true},
            {label: "Data Type", field: "baseType"},
            {label: "Last Data Time", field: "lastTime"}
          ];
          $scope.propsGridConfig.data = [];
          renderUITable($scope.propsGridConfig, "ThingPropsTable", propsGridColumns,
                  function (event) {
                    if (event.type == "dgrid-select") {
                      $scope.$apply(function () {
                        $scope.selectedProperty = event.rows[0].data;
                      });
                    } else if (event.type == "dgrid-deselect") {
                      $scope.$apply(function () {
                        $scope.selectedProperty = null;
                      });
                    }
                  }
          );

          var dataGridColumns = [
            {
              label: "Timestamp", field: "timestamp1", sortable: true,
              cellTemplate: "<div class='ui-grid-cell-contents'>{{row.entity.timestamp}}</div>"
            },
            {
              label: "Time", name: "timestamp", sortable: true,
              cellFilter: 'date:\'MM/dd/yyyy HH:MM:ss\''
            },
            {label: "Data Value", field: "value", sortable: true}
          ];
          $scope.dataGridConfig.data = [];
          renderUITable($scope.dataGridConfig, "PropsDataTable", dataGridColumns);
        }
        initTables();

        var buildPropsTable = function (thing) {
          $scope.propsGridConfig.data = [];
          if(!thing) return;
          var thingType = thing[THING_TYPE];
          if (!thingType || !thingType.id) return;
          var list = [];
          riots.properties(thingType.id, function (els) {
            $.each(els, function (idx, el) {
              list.push(el);
              var opts = {};
        	  opts[THING_ID] = $scope.shared.selectedThing.id;
      		  opts[PROPERTY_NAME] = el.name;
              riots.data(opts, function(dataItem) {
            	  if(dataItem) {
	            	  el.lastTime = dataItem.timestamp;
            	  }
              },
              function (data, status, headers, config) {
                // error callback (ignore)
              });
            })
          });
          $scope.propsGridConfig.data = list;
        };

        /* open websocket */
        var connectWebsocket = function () {
          var callback = function (data) {
            $scope.$apply(function () {
              $scope.dataGridConfig.data.unshift(data);
              var amount = parseInt($scope.dataOptions.numPoints);
              if (typeof amount != "number") {
                amount = defaultNumPoints;
              }
              while ($scope.dataGridConfig.data.length > amount) {
                $scope.dataGridConfig.data.pop();
              }
              renderVisualization();
            });
          }
          riots.subscribe({
                    thingId: $scope.shared.selectedThing.id,
                    propertyName: $scope.selectedProperty.name
                  }, callback
          );
        }

        $scope.displayPropertyData = function () {
          var prop = $scope.selectedProperty;
          if (!prop || !$scope.shared.selectedThing)
            return;
          var amount = $scope.dataOptions.numPoints;
          var opts = {};
    	  opts[THING_ID] = $scope.shared.selectedThing.id;
  		  opts[PROPERTY_NAME] = prop.name;
          opts.amount = amount;
          riots.data(opts, function(items) {
       		$scope.dataGridConfig.data = items;
          });
        }

        $scope.publishData = function () {
          var propName = $scope.selectedProperty.name;
          var data = {value: 1};
          riots.data(opts, function(items) {
       		$scope.dataGridConfig.data = items;
          });
          var opts = {};
    	  opts[THING_ID] =  $routeParams.thingID;
  		  opts[PROPERTY_NAME] = propName;
          riots.data(opts, data, function(items) {
       		// success
          });
        }

        var toggleLiveWatch = function () {
          if (!$scope.dataOptions.trackLive) {
            if ($scope.websocket)
              $scope.websocket.close();
            $scope.websocket = null;
          } else {
            connectWebsocket();
          }
        }

        var renderVisualization = function () {
          var type = $scope.dataOptions.visType;
          if (type == "chart") {
            renderGraph($scope.dataGridConfig.data);
          } else if (type == "map") {
            // TODO
          }
        }

        var renderGraph = function (values) {
          labels = [];
          datasets = [{data: []}];
          $.each(values, function (idx, val) {
            var isReverse = true;
            if (isReverse) {
              datasets[0].data.unshift(val.value);
              labels.unshift(formatDate(val.timestamp));
            } else {
              datasets[0].data.push(val.value);
              labels.push(formatDate(val.timestamp));
            }
          });
          drawLineChart("chart1", datasets, labels);
          $("#chartWrapper").show();
        }

        /* add event handlers*/
        $scope.$watch("shared.selectedThing", function (value) {
        	buildPropsTable($scope.shared.selectedThing);
	  	});
	    $scope.$watch("shared.selectedThing['" + THING_TYPE + "'].id", function (value) {
	    	buildPropsTable($scope.shared.selectedThing);
	    });
        $scope.$watch("selectedProperty", function (value) {
          $scope.displayPropertyData();
        });
        $scope.$watch("dataOptions.trackLive", function (value) {
          toggleLiveWatch();
        });
        $scope.$watch("dataOptions.visType", function (value) {
          renderVisualization();
        });

        /* start rendering the main container */

      }
    ]);

  </script>