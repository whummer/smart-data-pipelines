<section ng-controller="CompositeTypeController">
  <div ng-show="shared.selectedThingType">

    <div ng-hide="shared.selectedThingType.children">
      <img ng-src="{{shared.selectedThingType[IMAGE_DATA][0].href}}" class="img-responsive" style="margin: auto; max-height: 150px; max-width: 150px;">
    </div>

    <div id="d3" class="text-center"></div>

    <div class="container-fluid">

      <div class="row">
        <div class="col-md-5">

          <div style="margin-bottom: 10px"><span class="label label-primary">Available ThingTypes</span></div>
          <select size="10" multiple ng-multiple="true" ng-model="thingTypesSelected"
                  ng-options="c.name for c in thingTypesAll track by c.id"
                  class="form-control"></select>
        </div>

        <div class="col-md-2 text-center">
          <div class="hidden-sm hidden-xs" style="height: 55px"></div>
          <button style="margin-bottom: 10px; margin-top:10px;" ng-click="addChildren()" class="btn btn-sm btn-primary">Include
            <span class="glyphicon glyphicon-chevron-right hidden-xs hidden-sm"></span>
            <span class="glyphicon glyphicon-chevron-down hidden-md hidden-lg"></span>
          </button>
          <button style="margin-bottom: 10px; margin-top:10px;" ng-click="removeChildren()" class="btn btn-sm btn-primary">
            <span class="glyphicon glyphicon-chevron-up hidden-md hidden-lg"></span>
            <span class="glyphicon glyphicon-chevron-left hidden-xs hidden-sm"></span> Remove
          </button>
        </div>

        <div class="col-md-5">

          <div style="margin-bottom: 10px"><span class="label label-primary">Included in {{shared.selectedThingType.name}}</span></div>

          <select size="10" multiple ng-multiple="true" ng-model="childrenSelected"
                  ng-options="c.name for c in childrenAll track by c.id" class="form-control"></select>
        </div>

      </div>
    </div>
  </div>
</section>

<script type="text/javascript">
  var app = angular.module("app");
  app.controller('CompositeTypeController', function ($scope, $http, $compile, $log, $location) {

    AppController($scope, $http, $compile);

    $log.debug("Inside CompositeTypeController");

    $scope.thingTypesAll = [];
    $scope.thingTypesSelected = [];
    $scope.childrenAll = [];
    $scope.childrenSelected = [];

    //
    // prepare select inputs
    //
    var syncStateWithModel = function () {
      var thingType = $scope.shared.selectedThingType;
      thingType.children = [];
      $.each($scope.childrenAll, function (idx, el) {
        thingType.children.push(el.id);
      });

      renderTree();
    };

    $scope.addChildren = function () {
      $.each($scope.thingTypesSelected, function (idx, el) {
        $scope.childrenAll.push(el);
      });
      syncStateWithModel();
    };

    $scope.removeChildren = function () {
      $.each($scope.childrenSelected, function (idx, el) {
        arrayRemoveById($scope.childrenAll, el);
      });
      syncStateWithModel();
    };

    var loadSelects = function () {
      shared.thingTypes(function (thingTypes) {
        $scope.thingTypesAll = thingTypes;
      });

      if (!$scope.shared.selectedThingType) {
        return;
      }
      var theThingType = $scope.shared.selectedThingType;
      if (theThingType.children) {
        $.each(theThingType.children, function (idx, el) {
          if (el.id) {
            $scope.childrenAll.push(el);
          } else {
            $scope.childrenAll.push(shared.thingType(el));
          }
        });
      }

    };

    //
    // composite thing type visualization
    //
    var prepareTreeData = function () {
      $log.debug("ChildrenAll: ", $scope.childrenAll);
      var childrenWithParentLink = [];
      var doRender = true;
      angular.forEach($scope.childrenAll, function (value, key) {
        if (!value.name || !value[IMAGE_DATA] || !value[IMAGE_DATA][0]) {
        	doRender = false;
        	return;
        }

        $log.debug("Adding child: ", value.name);
        childrenWithParentLink.push({name: value.name, parent: $scope.shared.selectedThingType.name, thumbnail: value[IMAGE_DATA][0].href});
      });

      if(!doRender || !$scope.shared.selectedThingType[IMAGE_DATA]) {
        return false;
      }
      $log.debug("ChildrenWithParentLink: ", childrenWithParentLink);
      var treeData = [{
        thumbnail: $scope.shared.selectedThingType[IMAGE_DATA][0].href,
        "name": $scope.shared.selectedThingType.name,
        "children": childrenWithParentLink,
        parent: "null"
      }];
      var json = angular.toJson(treeData);

      $log.debug("Treedata for visualization: ", json);
      return angular.fromJson(json);
    };

    var renderTree = function () {
      var prepared = prepareTreeData();
      if(!prepared) {
    	  return;
      }
      drawCompositeThing(prepared);
    };


    //
    // register event listeners
    //
    $scope.$watch("thingTypesAll", renderTree);
    $scope.$watch("shared.selectedThingType", function () {
      loadSelects();
    });

  });

</script>
