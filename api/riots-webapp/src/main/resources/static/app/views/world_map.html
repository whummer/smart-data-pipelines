<section ng-controller="WorldMapController" id="WorldMapContainer" style="height: 100%;">
	<link rel="stylesheet" type="text/css" href="/bower_components/leaflet/dist/leaflet.css" />
	<!--<div style="height:{{canvas.height}}px; width:{{canvas.width}}px; padding: 0px; position: relative;" id="worldMapWrapper">-->
	<div style="position: relative; height: 100%; width: 100%;"  id="worldMapWrapper">
		<div id="worldMap" style="width: 100%; height: 100%;"></div>
	</div>
</section>

<script>
app = angular.module("app");
app.controller('WorldMapController', [
	'$scope', '$http', '$compile',
	function($scope, $http, $compile) {

		require(["leaflet"],
		  function (L) {

			$scope.currentLocation = null;
			$scope.canvas = { height: 300, width: 300 }
			$scope.defaultLocation = [ 48.19742, 16.37127 ];

			$scope.renderMap = function() {

				//console.log("render map", $scope.map);
				var wrapper = $("#worldMap");
				if($scope.map) {
					var map = wrapper[0];
					console.log("$scope.map", $scope.map, map, map._leaflet);
					$scope.map.remove();
					map.innerHTML = "";
					wrapper.html("");
					delete map._leaflet;
					console.log("$scope.map 1", $scope.map, map._leaflet, map);
					$scope.map = null;
				}

				initMapsMarkers(L);

				function setupDropZone () {
					var mapCanvas = $("#worldMap");
					mapCanvas.on("dragenter", function (event) {
						event.preventDefault();
					});
					mapCanvas.on("dragover", function (event) {
						event.preventDefault();
					});

					mapCanvas.droppable({
						drop: function(event, el) {
							try {
								loc = $scope.map.mouseEventToLatLng(event);
								var object = $(el.draggable[0]).scope().row.entity;
								var source = el.draggable[0].parentElement.parentElement.parentElement.parentElement;
								if(source.id == "thingTypesTable") {
									var thingType = $scope.prepareModelValues(object, true);
									$scope.addThingToMap(loc, thingType);
								} else if(source.id == "assetsTable") {
									object = byId($scope.shared.listOfThings, object.id)[0];
									var thingType = $scope.prepareModelValues(object.thingType, true);
									object.thingType = thingType;
									delete object["$$hashKey"];
									$scope.updateThingLocationOnMap(loc, object);
								}
							} catch(e) {
								console.log("Unable to complete drag&drop:", e);
							}
						}
					});
				}

				$scope.map = L.map("worldMap", {
								"maxZoom": 23,
								"__markers": []
							}).
							setView($scope.defaultLocation, 18).
							on("mouseup", function(e) {
								var newLoc = $scope.map.getCenter();
								if(!newLoc.equals($scope.currentLocation)) {
									eventBus.publish("change.currentMapLocation", newLoc);
								}
								$scope.currentLocation = newLoc;
							});
				L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
					maxZoom: 23,
					maxNativeZoom: 19
				}).addTo($scope.map);

				setupDropZone();

				if($scope.shared.listOfThings) {
					displayMarkers($scope.shared.listOfThings, true);
				}
			}

			$scope.deleteMarkerFromMap = function (marker) {
				$scope.map.removeLayer(marker);
			};
	
			$scope.addThingToMap = function(position, thingType) {
				if(!position) {
					position = $scope.map.getCenter();
				}
				asset = {
					"name": "unnamed", 
					"location": {
						"latitude": position.lat,
						"longitude": position.lng
					},
					"thingType": thingType
				};
				$scope.createAsset(asset);
			};
			
			$scope.updateThingLocationOnMap = function(position, asset) {
				if(!position) {
					position = $scope.map.getCenter();
				}
				asset.location = {
					"latitude": position.lat,
					"longitude": position.lng
				};
				var idx = $.inArray(asset, $scope.shared.listOfThings);
				//console.log("updating location of asset #" + idx + ":", position, asset);
				$scope.updateThing(asset);
			}

			$scope.createAsset = function(asset) {
				$scope.addThingInDB(asset, function(assetSaved) {
					$scope.loadThingsFromDB();
					eventBus.publish("addOrDel.Asset", assetSaved);
				});
			};

			$scope.updateThing = function(asset) {
				$scope.updateThingInDB(asset, function(asset) {
					eventBus.publish("addOrDel.Asset", asset);
				});
			};

			var displayMarkers = function (markers, deleteExisting) {
				if(typeof $scope.map == 'undefined') {
					console.warn("map is undefined");
					return;
				}
				if(!markers) {
					return;
				}
				if(deleteExisting) {
					$.each($scope.map.options.__markers, function(index, marker) {
						$scope.deleteMarkerFromMap(marker);
					});
					$scope.map.options.__markers = [];
				}

				$.each(markers, function(index, marker) {
					//console.log("adding marker: ", marker.location);
					if(marker.location && marker.location.latitude
							&& marker.location.longitude) {
						$scope.addMarker(marker);
					} else {
						console.warn("Marker has no valid location:", marker);
					}
				});

			};

			$scope.addMarker = function(m) {
				var marker = L.marker(
					[ m.location ? m.location.latitude : m.lat, 
					  m.location ? m.location.longitude : m.lon], 
					{
						draggable : true,
						title: m.name,
						userdata: m
					}
				).animateDragging().
				bindPopup(m.name).
				on("click", function() {
					$scope.$apply(function(){
						$scope.shared.selectedThing = m;
					});
				}).
				on("dragend", function(e) {
					asset = e.target.options.userdata;
					asset.location = {
						"latitude": e.target.getLatLng().lat,
						"longitude": e.target.getLatLng().lng
					}
					$scope.updateThing(asset);
				});
				$scope.map.addLayer(marker);
				$scope.map.options.__markers.push(marker);
				//marker.addTo(map);
				return marker;
			};

			/* register event handlers */
			$scope.subscribeOnce("addOrDel.Asset", function() {
				if($scope.shared.listOfThings) {
					displayMarkers($scope.shared.listOfThings, true);
				}
			}, "addOrDel.Asset.worldMap");
			$scope.subscribeOnce("loadAll.Asset", function(event) {
				if(event.assets) {
					displayMarkers(event.assets, true);
				}
			}, "loadAll.Asset.worldMap");
			$scope.$watch("shared.listOfThings", function() {
				displayMarkers($scope.shared.listOfThings, true);
			});

			/* render main element */
			$scope.renderMap();
			if($scope.loadThingsFromDB && $scope.worldViewEditMode !== false) {
				$scope.loadThingsFromDB();
			}

		});

	}
]);
</script>