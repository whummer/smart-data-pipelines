<section ng-controller="DeviceTypeDetailsController" id="devTypeDetailsSection" style="height: 100%;">

    <div ng-show="shared.selectedDeviceType">

        <form class="form-horizontal" role="form" style="width: 100%">

            <!-- device type ID -->
            <div class="form-group">
                <label for="devTypeId" class="col-sm-2 control-label">ID</label>

                <div class="col-sm-10">
                    <input id="devTypeId" disabled="disabled" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType.id"/>
                </div>
            </div>

            <!-- device type name -->
            <div class="form-group">
                <label for="devTypeName" class="col-sm-2 control-label">Name</label>

                <div class="col-sm-10">
                    <input id="devTypeName" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType.name"/>
                </div>
            </div>

            <!-- device type name -->
            <div class="form-group">
                <label for="devTypeDescr" class="col-sm-2 control-label">Description</label>

                <div class="col-sm-10">
						<textarea id="devTypeDescr" class="form-control input-sm"
                                  data-ng-model="shared.selectedDeviceType.description">
                        </textarea>
                </div>
            </div>

            <!-- device type image URL -->
            <div class="form-group">
                <label for="devTypeImageUrl" class="col-sm-2 control-label">Image URL</label>

                <div class="col-sm-10">
                    <input id="devTypeImageUrl" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType.imageUrl">
                </div>
            </div>

            <!-- device type manufactures -->
            <div class="form-group">
                <label for="devTypeManufacturers" class="col-sm-2 control-label">Manufacturer</label>

                <div class="col-sm-10">
                    <select id="devTypeManufacturers" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.manufacturers track by opt.id"
                            ng-model="shared.selectedDeviceType.manufacturer">
                    </select>
                </div>
            </div>

            <!-- semantic type for device type -->
            <div class="form-group">
                <label for="devTypeSemantics" class="col-sm-2 control-label">Semantics</label>

                <div class="col-sm-10">
                    <select id="devTypeSemantics" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.semanticDeviceTypes track by opt.id"
                            ng-model="shared.selectedDeviceType.semanticType">
                    </select>
                </div>
            </div>

            <!-- device type tags -->
            <div class="form-group">
                <div id="devTypeTags" class="tag-list" />
            </div>

            <hr/>

            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 text-right">
                    <button class="btn btn-default btn-sm btn-primary" id="btnDevTypeSave"><span class="glyphicon glyphicon-ok"></span> Save Changes</button>
                    <a href="#/catalog" class="btn btn-default btn-sm btn-info"><span class="glyphicon glyphicon-remove"></span> Cancel</a>
                </div>
            </div>
        </form>
    </div>

</section>

<script type="text/javascript">

    var app = angular.module("app");
    app.controller('DeviceTypeDetailsController', [
        '$scope', '$http', '$compile',
        function ($scope, $http, $compile) {

            AppController($scope, $http, $compile);

            require(["bootstrap-tags"], function () {

                $scope.getPropertyList = function (devType) {
                    if (!devType)
                        return [];
                    if (!devType.propertyList) {
                        devType.propertyList = [];
                        for (var key in devType.properties) {
                            var entry = {key: key, value: devType.properties[key]};
                            devType.propertyList.push(entry);
                        }
                    }
                    return devType.propertyList;
                };

                $scope.applyProperties = function () {
                    /* apply tags */
                    //$scope.shared.selectedDeviceType.tags = $("#devTypeTags").tagit("assignedTags");
                };

                $scope.addProperty = function () {
                    $scope.applyProperties();
                    $scope.$apply(function () {
                        $scope.shared.selectedDeviceType.properties["__new_key__"] = "new_value";
                        $scope.getPropertyList($scope.shared.selectedDeviceType);
                    });
                };

                $scope.loadManufacturers = function () {
                    if (!$scope.shared.manufacturers) {
                        invokeGET($http, $scope.semanticsAPI + "/Manufacturer",
                                function (data, status, headers, config) {
                                    $scope.shared.manufacturers = data.result;
                                });
                    }
                };

                $scope.loadSemanticTypes = function () {
                    if (!$scope.shared.semanticDeviceTypes) {
                        invokeGET($http, $scope.semanticsAPI + "/Device",
                                function (data, status, headers, config) {
                                    $scope.shared.semanticDeviceTypes = data.result;
                                });
                    }
                };

                $scope.saveDetails = function () {
                    console.log("Saving details");
                    $scope.applyProperties();
                    eventBus.publish("change.DeviceTypeProps", {changedItem: $scope.shared.selectedDeviceType});
                };

                /* register event handlers */
                // TODO $scope.onRenderElement("selDevTypeManuf", $scope.loadManufacturers);
                // TODO $scope.onRenderElement("selSemantDevType", $scope.loadSemanticTypes);
                $scope.loadManufacturers();
                $scope.loadSemanticTypes();
                $scope.addClickHandler("btnDevTypeAddAttr", $scope.addProperty);
                $scope.addClickHandler("btnDevTypeSave", $scope.saveDetails);
               /* $scope.$watch("shared.selectedDeviceType", function () {
                    if ($scope.shared.selectedDeviceType) {

                        $.each($scope.shared.selectedDeviceType.tags, function (idx, el) {
                            console.log("Adding tag " + el);
                        });
                    }
                });*/

                /* render main element */
                //$("#devTypeTags").tags().addTag("Test");

            });
        }
    ]);

</script>
