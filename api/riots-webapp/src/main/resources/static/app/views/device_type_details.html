<!-- todo move to external CSS file -->
<style>
    .bootstrap-tagsinput {
        width: 100% !important;
    }
</style>

<section ng-controller="DeviceTypeDetailsController" id="devTypeDetailsSection" style="height: 100%;">

    <div ng-show="shared.selectedDeviceType">

        <form class="form-horizontal" role="form" style="width: 100%">

            <!-- device type ID -->
            <div class="form-group">
                <label for="devTypeId" class="col-sm-2 control-label">ID</label>

                <div class="col-sm-10">
                    <input id="devTypeId" disabled="disabled" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType.id"/>
                </div>
            </div>

            <!-- device type name -->
            <div class="form-group">
                <label for="devTypeName" class="col-sm-2 control-label">Name</label>

                <div class="col-sm-10">
                    <input id="devTypeName" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType.name"/>
                </div>
            </div>

            <!-- device type name -->
            <div class="form-group">    
                <label for="devTypeDescr" class="col-sm-2 control-label">Description</label>

                <div class="col-sm-10">
						<textarea id="devTypeDescr" class="form-control input-sm"
                                  data-ng-model="shared.selectedDeviceType.description">
                        </textarea>
                </div>
            </div>

            <!-- device type image URL -->
            <div class="form-group">
                <label for="devTypeImageUrl" class="col-sm-2 control-label">Image URL</label>

                <div class="col-sm-10">
                    <input id="devTypeImageUrl" class="form-control input-sm"
                           data-ng-model="shared.selectedDeviceType['image-urls'][0]">
                </div>
            </div>

            <!-- device type manufactures -->
            <div class="form-group">
                <label for="devTypeManufacturers" class="col-sm-2 control-label">Manufacturer</label>

                <div class="col-sm-10">
                    <select id="devTypeManufacturers" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.manufacturers track by opt.id"
                            ng-model="shared.selectedDeviceType.manufacturer">
                    </select>
                </div>
            </div>

            <!-- semantic type for device type -->
            <div class="form-group">
                <label for="devTypeSemantics" class="col-sm-2 control-label">Semantics</label>

                <div class="col-sm-10">
                    <select id="devTypeSemantics" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.semanticDeviceTypes track by opt.id"
                            ng-model="shared.selectedDeviceType.semanticType">
                    </select>
                </div>
            </div>



            <!-- device type tags -->
            <div class="form-group">
                <label for="devTypeTags" class="col-sm-2 control-label">Tags</label>

                <div class="col-sm-10">
                    <input id="devTypeTags" class="form-control input-sm"  data-role="tagsinput"/>
                </div>
            </div>

            <!--<div class="row">-->
                <!--<div class="col-xs-2">-->
                    <!--<input type="text" class="form-control" placeholder=".col-xs-2">-->
                <!--</div>-->
                <!--<div class="col-xs-3">-->
                    <!--<input type="text" class="form-control" placeholder=".col-xs-3">-->
                <!--</div>-->
                <!--<div class="col-xs-4">-->
                    <!--<input type="text" class="form-control" placeholder=".col-xs-4">-->
                <!--</div>-->
            <!--</div>-->

            <!--<div class="form-group">-->
                <!--<label for=""></label>Attributes:</td><td>-->
                <!--<table>-->
                    <!--<tr ng-repeat="n in range(0, getPropertyList(shared.selectedDeviceType).length - 1)">-->
                        <!--<td><input class="domPropValue form-control input-sm"-->
                                   <!--ng-model="shared.selectedDeviceType.propertyList[n].key" style="width: 30%"/>-->
                            <!--=-->
                            <!--<input class="domPropValue form-control input-sm"-->
                                   <!--ng-model="shared.selectedDeviceType.propertyList[n].value" style="width: 60%" />-->
                        <!--</td>-->
                    <!--</tr>-->
                <!--</table>-->
                <!--<button class="btn btn-default btn-sm"  id="btnDevTypeAddAttr">Add Attribute</button>-->
            <!---->
            <!--</div>-->


            <hr/>

            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 text-right">
                    <button class="btn btn-default btn-sm btn-primary" id="btnDevTypeSave"><span class="glyphicon glyphicon-ok"></span> Save Changes</button>
                    <a href="#/catalog" class="btn btn-default btn-sm btn-info"><span class="glyphicon glyphicon-remove"></span> Cancel</a>
                </div>
            </div>
        </form>
    </div>

</section>

<script type="text/javascript">

    var app = angular.module("app");
    app.controller('DeviceTypeDetailsController', function ($scope, $http, $compile, $log) {

            AppController($scope, $http, $compile);

            require(["bootstrap-tagsinput"], function () {

                $scope.getPropertyList = function (devType) {
                    if (!devType)
                        return [];
                    if (!devType.propertyList) {
                        devType.propertyList = [];
                        for (var key in devType.properties) {
                            var entry = {key: key, value: devType.properties[key]};
                            devType.propertyList.push(entry);
                        }
                    }
                    return devType.propertyList;
                };

                $scope.applyProperties = function () {
                    /* apply tags */
                    var devTypeTags = $("#devTypeTags");
                    $log.info("Tags input: ", devTypeTags.tagsinput('val'));
                    $scope.shared.selectedDeviceType.tags = devTypeTags.tagsinput('items');
                    $log.info("Scope tags: ", $scope.shared.selectedDeviceType.tags);
                };

                $scope.addProperty = function () {
                    $scope.applyProperties();
                    $scope.$apply(function () {
                        $scope.shared.selectedDeviceType.properties["__new_key__"] = "new_value";
                        $scope.getPropertyList($scope.shared.selectedDeviceType);
                    });
                };

                $scope.loadManufacturers = function () {
                    $log.info("Loading manufacturers from catalog service via URL ", appConfig.services.manufacturers.url);
                    if (!$scope.shared.manufacturers) {
                        invokeGET($http, appConfig.services.manufacturers.url,
                                function (data, status, headers, config) {
                                    $scope.shared.manufacturers = data.result;
                                });
                    }
                };

                $scope.loadSemanticTypes = function () {
                    if (!$scope.shared.semanticDeviceTypes) {
                        invokeGET($http, $scope.semanticsAPI + "/Device",
                                function (data, status, headers, config) {
                                    $scope.shared.semanticDeviceTypes = data.result;
                                });
                    }
                };

                $scope.saveDeviceType = function() {
                    var deviceType = $scope.shared.selectedDeviceType;
                    $scope.applyProperties();
                    $log.info("Entering save for device: ", deviceType);
                    deviceType = JSON.parse(JSON.stringify(deviceType));
                    $scope.prepareModelValues(deviceType);
                    delete deviceType.drivers;
                    console.log("saving deviceType", deviceType);
                    invokePUT($scope.http, $scope.deviceTypesAPI,
                            JSON.stringify(deviceType),
                            function (data, status, headers, config) {
                                $log.info("Invoked PUT for deviceType ", deviceType);
                                //$scope.loadAllDeviceTypes();
                            }
                    );
                };

                /* register event handlers */
                $scope.loadManufacturers();
                //$scope.loadSemanticTypes();
                $scope.addClickHandler("btnDevTypeAddAttr", $scope.addProperty);
                $scope.addClickHandler("btnDevTypeSave", $scope.saveDeviceType);
                $scope.$watch("shared.selectedDeviceType", function () {
                    $log.info("Watching selected deviceType: ", ($scope.shared.selectedDeviceType));
                    if ($scope.shared.selectedDeviceType.tags) {
                        $.each($scope.shared.selectedDeviceType.tags, function (idx, el) {
                            console.log("Adding tag " + el);
                            $("#devTypeTags").tagsinput("add", el);
                        });

                    }
                });

                $("#devTypeTags").tagsinput();

                //console.dir($scope.shared.selectedDeviceType)




            });
        }
    );

</script>
