<!-- todo move to external CSS file -->
<style>
    .bootstrap-tagsinput {
        width: 100% !important;
    }
</style>

<section ng-controller="ThingTypeDetailsController" id="devTypeDetailsSection" style="height: 100%;">

    <div ng-show="shared.selectedThingType">

        <form class="form-horizontal" role="form" style="width: 100%">

            <!-- thing type ID -->
            <div class="form-group">
                <label for="devTypeId" class="col-sm-2 control-label">ID</label>

                <div class="col-sm-10">
                    <input id="devTypeId" disabled="disabled" class="form-control input-sm"
                           data-ng-model="shared.selectedThingType.id"/>
                </div>
            </div>

            <!-- thing type name -->
            <div class="form-group">
                <label for="devTypeName" class="col-sm-2 control-label">Name</label>

                <div class="col-sm-10">
                    <input id="devTypeName" class="form-control input-sm"
                           data-ng-model="shared.selectedThingType.name"/>
                </div>
            </div>

            <!-- thing type name -->
            <div class="form-group">    
                <label for="devTypeDescr" class="col-sm-2 control-label">Description</label>

                <div class="col-sm-10">
						<textarea id="devTypeDescr" class="form-control input-sm"
                                  data-ng-model="shared.selectedThingType.description">
                        </textarea>
                </div>
            </div>

            <!-- thing type image URL -->
            <div class="form-group">
                <label for="devTypeImageUrl" class="col-sm-2 control-label">Image URL</label>

                <div class="col-sm-10">
                    <input id="devTypeImageUrl" class="form-control input-sm"
                           data-ng-model="shared.selectedThingType.imageUrl">
                </div>
            </div>

            <!-- thing type manufactures -->
            <div class="form-group">
                <label for="devTypeManufacturers" class="col-sm-2 control-label">Manufacturer</label>

                <div class="col-sm-10">
                    <select id="devTypeManufacturers" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.manufacturers track by opt.id"
                            ng-model="shared.selectedThingType.manufacturer">
                    </select>
                </div>
            </div>

            <!-- semantic type for thing type -->
            <div class="form-group">
                <label for="devTypeSemantics" class="col-sm-2 control-label">Semantics</label>

                <div class="col-sm-10">
                    <select id="devTypeSemantics" class="form-control input-sm"
                            ng-options="opt.name for opt in shared.semanticThingTypes track by opt.id"
                            ng-model="shared.selectedThingType.semanticType">
                    </select>
                </div>
            </div>


            <!-- thing type tags -->
            <div class="form-group">
                <label for="devTypeTags" class="col-sm-2 control-label">Tags</label>

                <div class="col-sm-10">
                    <input id="devTypeTags" class="form-control input-sm"  data-role="tagsinput"/>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-2">
                    <input type="text" class="form-control" placeholder=".col-xs-2">
                </div>
                <div class="col-xs-3">
                    <input type="text" class="form-control" placeholder=".col-xs-3">
                </div>
                <div class="col-xs-4">
                    <input type="text" class="form-control" placeholder=".col-xs-4">
                </div>
            </div>

            <div class="form-group">
                <label for=""></label>Attributes:</td><td>
                <table>
                    <tr ng-repeat="n in range(0, getPropertyList(shared.selectedThingType).length - 1)">
                        <td><input class="domPropValue form-control input-sm"
                                   ng-model="shared.selectedThingType.propertyList[n].key" style="width: 30%"/>
                            =
                            <input class="domPropValue form-control input-sm"
                                   ng-model="shared.selectedThingType.propertyList[n].value" style="width: 60%" />
                        </td>
                    </tr>
                </table>
                <button class="btn btn-default btn-sm"  id="btnDevTypeAddAttr">Add Attribute</button>
            
            </div>


            <hr/>

            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10 text-right">
                    <button class="btn btn-default btn-sm btn-primary" id="btnDevTypeSave"><span class="glyphicon glyphicon-ok"></span> Save Changes</button>
                    <a href="#/catalog" class="btn btn-default btn-sm btn-info"><span class="glyphicon glyphicon-remove"></span> Cancel</a>
                </div>
            </div>
        </form>
    </div>

</section>

<script type="text/javascript">

    var app = angular.module("app");
    app.controller('ThingTypeDetailsController', [
        '$scope', '$http', '$compile',
        function ($scope, $http, $compile) {

            AppController($scope, $http, $compile);

            require(["bootstrap-tagsinput"], function () {

                $scope.getPropertyList = function (devType) {
                    if (!devType)
                        return [];
                    if (!devType.propertyList) {
                        devType.propertyList = [];
                        for (var key in devType.properties) {
                            var entry = {key: key, value: devType.properties[key]};
                            devType.propertyList.push(entry);
                        }
                    }
                    return devType.propertyList;
                };

                $scope.applyProperties = function () {
                    /* apply tags */
                    $scope.shared.selectedThingType.tags = $("#devTypeTags").tagsinput('items');
                    console.dir($scope.shared.selectedThingType.tags)
                };

                $scope.addProperty = function () {
                    $scope.applyProperties();
                    $scope.$apply(function () {
                        $scope.shared.selectedThingType.properties["__new_key__"] = "new_value";
                        $scope.getPropertyList($scope.shared.selectedThingType);
                    });
                };

                $scope.loadManufacturers = function () {
                    if (!$scope.shared.manufacturers) {
                        invokeGET($http, $scope.semanticsAPI + "/Manufacturer",
                                function (data, status, headers, config) {
                                    $scope.shared.manufacturers = data.result;
                                });
                    }
                };

                $scope.loadSemanticTypes = function () {
                    if (!$scope.shared.semanticThingTypes) {
                        invokeGET($http, $scope.semanticsAPI + "/Thing",
                                function (data, status, headers, config) {
                                    $scope.shared.semanticThingTypes = data.result;
                                });
                    }
                };

                $scope.saveDetails = function () {
                    console.log("Saving details");
                    $scope.applyProperties();
                    eventBus.publish("change.ThingTypeProps", {changedItem: $scope.shared.selectedThingType});
                };

                /* register event handlers */
                $scope.loadManufacturers();
                $scope.loadSemanticTypes();
                $scope.addClickHandler("btnDevTypeAddAttr", $scope.addProperty);
                $scope.addClickHandler("btnDevTypeSave", $scope.saveDetails);
                $scope.$watch("shared.selectedThingType", function () {
                    console.log("watched");
                    console.dir($scope.shared.selectedThingType);
                    if ($scope.shared.selectedThingType) {
                        $.each($scope.shared.selectedThingType.tags, function (idx, el) {
                            console.log("Adding tag " + el);
                            $("#devTypeTags").tagsinput("add", el);
                        });

                    }
                });

                $("#devTypeTags").tagsinput();

                //console.dir($scope.shared.selectedThingType)




            });
        }
    ]);

</script>
