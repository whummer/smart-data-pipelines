<section ng-controller="DeviceTypePropsController" id="devicePropsSection" style="height: 100%">

    <div ng-show="shared.selectedDeviceType">

        <div style="margin-bottom: 10px;" class="text-right">
            <button class="btn btn-primary btn-sm" id="btnDeviceTypePropAdd">
                <span class="glyphicon glyphicon-plus"></span> Add New Property
            </button>
            <button class="btn btn-warning btn-sm" id="btnDeviceTypePropDelete"><span
                    class="glyphicon glyphicon-minus"></span> Delete Property
            </button>
        </div>

        <!-- table view for device properties -->
        <div id="DeviceTypePropsTable" ui-grid="gridConfig" ui-grid-selection ui-grid-edit ui-grid-row-edit
             class="grid"></div>

        <div ng-show="selectedProperty">

            <form class="form-horizontal" role="form" style="text-align: left">

                <!-- property name -->
                <div class="form-group">
                    <label for="propName" class="col-sm-3 control-label">Property Name</label>

                    <div class="col-sm-9">
                        <input id="propName" class="form-control input-sm" ng-model="selectedProperty.name"/>
                    </div>
                </div>

                <!-- value type -->
                <div class="form-group">
                    <label for="selBaseType" class="col-sm-3 control-label">Value Type</label>

                    <div class="col-sm-9">
                        <select id="selBaseType" class="form-control input-sm"
                                ng-model="selectedProperty.baseType">
                            <option value="BOOLEAN">BOOLEAN</option>
                            <option value="STRING">STRING</option>
                            <option value="DOUBLE">DOUBLE</option>
                            <option value="LONG">LONG</option>
                            <option value="LIST">LIST</option>
                        </select>
                    </div>
                </div>

                <!-- semantic type of property -->
                <div class="form-group">
                    <label for="selSemanticType" class="col-sm-3 control-label">Semantic Type</label>

                    <div class="col-sm-9">
                        <select id="selSemanticType" class="form-control input-sm"
                                ng-options="opt.name for opt in shared.semanticPropertyTypes track by opt.id"
                                ng-model="selectedProperty.semanticType">
                        </select>
                    </div>
                </div>


                <!--
                                TODO do we really need this?
                                <div class="form-group">
                                    <label for="selParentProp" class="col-sm-3 control-label">Parent Property</label>

                                    <div class="col-sm-9">
                                        <select id="selParentProp" class="form-control input-sm"
                                                ng-options="opt.name for opt in gridConfig.data track by opt.id"
                                                ng-model="selectedProperty.parentProp">
                                        </select>
                                    </div>
                                </div>
                -->


                <!-- value domain (e.g. discrete) for this property -->
                <div class="form-group" ng-show="selectedProperty.baseType != 'LIST'">
                    <label for="selDomainType" class="col-sm-3 control-label">Value Domain</label>

                    <div class="col-sm-9">
                        <select id="selDomainType" class="form-control input-sm"
                                ng-model="selectedProperty.valueDomain.type">
                            <option value="Continuous">Continuous (min/max)</option>
                            <option value="Discrete">Discrete (min/max/steps)</option>
                            <option value="Enumerated">Enumeration (values)</option>
                        </select>
                    </div>
                </div>

                <!--

                                <tr >
                                    <td style="vertical-align: top">Values:</td>
                                    <td>
                                        <table>
                                            <tr ng-repeat="n in range(0, selectedProperty.valueDomain.values.length - 1)">
                                                <td><input class="domPropValue" class="form-control input-sm"
                                                           ng-model="selectedProperty.valueDomain.values[n]"/></td>
                                            </tr>
                                        </table>
                                        <button class="btn btn-default btn-sm" data-dojo-props="iconClass:'icon-plus-sign'"
                                                id="btnDeviceTypePropAddValue">Add Value
                                        </button>
                                    </td>
                                </tr>

                                <tr ng-show="(selectedProperty.baseType == 'LONG' || selectedProperty.baseType == 'DOUBLE') && selectedProperty.valueDomain.type != 'Enumerated'">
                                    <td>Min. / Max. Values:</td>
                                    <td>
                                        <input id="propMinVal" class="form-control input-sm"
                                               ng-model="selectedProperty.valueDomain.min" style="width: 30%"/> /
                                        <input id="propMaxVal" class="form-control input-sm"
                                               ng-model="selectedProperty.valueDomain.max" style="width: 30%"/>
                                    </td>
                                </tr>

                                <tr ng-show="(selectedProperty.baseType == 'LONG' || selectedProperty.baseType == 'DOUBLE') && selectedProperty.valueDomain.type == 'Discrete'">
                                    <td>Step Increment:</td>
                                    <td>
                                        <input id="propStepVal" class="form-control input-sm"
                                               data-ng-model="selectedProperty.valueDomain.step"/>
                                    </td>
                                </tr>
                -->


                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10 text-right">
                        <button class="btn btn-default btn-sm btn-primary" id="btnDeviceTypePropSave"><span class="glyphicon glyphicon-ok"></span> Save Changes
                        </button>
                        <a href="#/catalog" class="btn btn-default btn-sm btn-info"><span class="glyphicon glyphicon-remove"></span> Cancel</a>
                    </div>
                </div>

            </form>


            <!--<table style="width: 100%;">
                <tr>
                    <td>Property Name:</td>
                    <td>
                        <input id="propName" class="form-control input-sm"
                               ng-model="selectedProperty.name"/>
                    </td>
                </tr>
                <tr>
                    <td>Base Type:</td>
                    <td>
                        <select id="selBaseType" class="form-control input-sm"
                                ng-model="selectedProperty.baseType">
                            <option value="BOOLEAN">BOOLEAN</option>
                            <option value="STRING">STRING</option>
                            <option value="DOUBLE">DOUBLE</option>
                            <option value="LONG">LONG</option>
                            <option value="LIST">LIST</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Semantic Type:</td>
                    <td>
                        <select id="selSemanticType" class="form-control input-sm"
                                ng-options="opt.name for opt in shared.semanticPropertyTypes track by opt.id"
                                ng-model="selectedProperty.semanticType">
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Parent Property:</td>
                    <td>
                        <select id="selParentProp" class="form-control input-sm"
                                ng-options="opt.name for opt in gridConfig.data track by opt.id"
                                ng-model="selectedProperty.parentProp">
                        </select>
                    </td>
                </tr>
                <tr ng-show="selectedProperty.baseType != 'LIST'">
                    <td>Value Domain Type:</td>
                    <td>
                        <select id="selDomainType" class="form-control input-sm"
                                ng-model="selectedProperty.valueDomain.type">
                            <option value="Continuous">Continuous (min/max)</option>
                            <option value="Discrete">Discrete (min/max/steps)</option>
                            <option value="Enumerated">Enumeration (values)</option>
                        </select>
                    </td>
                </tr>
                <tr ng-show="selectedProperty.baseType != 'LIST' && selectedProperty.valueDomain.type == 'Enumerated'">
                    <td style="vertical-align: top">Values:</td>
                    <td>
                        <table>
                            <tr ng-repeat="n in range(0, selectedProperty.valueDomain.values.length - 1)">
                                <td><input class="domPropValue" class="form-control input-sm"
                                           ng-model="selectedProperty.valueDomain.values[n]"/></td>
                            </tr>
                        </table>
                        <button class="btn btn-default btn-sm" data-dojo-props="iconClass:'icon-plus-sign'"
                                id="btnDeviceTypePropAddValue">Add Value
                        </button>
                    </td>
                </tr>
                <tr ng-show="(selectedProperty.baseType == 'LONG' || selectedProperty.baseType == 'DOUBLE') && selectedProperty.valueDomain.type != 'Enumerated'">
                    <td>Min. / Max. Values:</td>
                    <td>
                        <input id="propMinVal" class="form-control input-sm"
                               ng-model="selectedProperty.valueDomain.min" style="width: 30%"/> /
                        <input id="propMaxVal" class="form-control input-sm"
                               ng-model="selectedProperty.valueDomain.max" style="width: 30%"/>
                    </td>
                </tr>
                <tr ng-show="(selectedProperty.baseType == 'LONG' || selectedProperty.baseType == 'DOUBLE') && selectedProperty.valueDomain.type == 'Discrete'">
                    <td>Step Increment:</td>
                    <td>
                        <input id="propStepVal" class="form-control input-sm"
                               data-ng-model="selectedProperty.valueDomain.step"/>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <button class="btn btn-default btn-sm btn-primary" data-dojo-props="iconClass:'icon-save'"
                                id="btnDeviceTypePropSave">Save Changes
                        </button>
                    </td>
                </tr>
            </table>-->

        </div>
        <br class="clear"/>
    </div>

</section>

<style>
    #DeviceTypePropsTable {
        height: 200px;
        width: 99%;
    }
</style>

<script type="text/javascript">

    var app = angular.module("app");
    app.controller('DeviceTypePropsController', [
        '$scope', '$http', '$compile',
        function ($scope, $http, $compile) {

            AppController($scope, $http, $compile);

            $scope.selectedProperty = null;
            $scope.gridConfig = {};

            $scope.initPropsTable = function () {
                var columnsConfig = [
                    {label: "Name", field: "displayName", sortable: true},
                    {label: "Data Type", field: "baseType"},
                    {label: "Value Domain Type", field: "valueDomain.type"}
                ];
                $scope.gridConfig.data = [{name: 1}];
                renderUITable($scope.gridConfig, "DeviceTypePropsTable", columnsConfig,
                        function (event) {
                            if (event.type == "dgrid-select") {
                                $scope.$apply(function () {
                                    $scope.selectedProperty = event.rows[0].data;
                                });

                                $scope.buildParentPropsSelect();
                                eventBus.publish("select.DeviceTypeProps", $scope.selectedProperty);
                            } else if (event.type == "dgrid-deselect") {
                                $scope.$apply(function () {
                                    $scope.selectedProperty = null;
                                });
                                eventBus.publish("select.DeviceTypeProps", $scope.selectedProperty);
                            } else if (event.type == "dgrid-datachange") {
                                var data = event.grid.row(event).data;
                                data[event.cell.column.field] = event.value;
                                $scope.prepareModelValues($scope.shared.selectedDeviceType);

                                $scope.saveDeviceTypeProp(data);
                            }

                            /* adjust UI elements */
                            eventBus.publish("change.SelectedProperty");
                        }
                );
            }
            $scope.initPropsTable();

            $scope.buildPropsTable = function (deviceType) {
                $.each(deviceType.deviceProperties, function (idx, el) {
                    expandChildProps(el, null, deviceType.deviceProperties);
                });
                $scope.gridConfig.data = deviceType.deviceProperties;
            };
            var expandChildProps = function (prop, parent, propsList) {
                prop.displayName = (parent ? (parent.displayName + ".") : "") + prop.name;
                if (!prop.children) {
                    return;
                }
                $.each(prop.children, function (idx, el) {
                    propsList.push(el);
                    el.parentProp = prop;
                    expandChildProps(el, prop, propsList);
                });
                prop.children = [];
            };

            $scope.buildParentPropsSelect = function (deviceType) {
                if (!deviceType) {
                    deviceType = $scope.shared.selectedDeviceType;
                }
                var propsList = [];
                propsList.push({id: -1, name: "ROOT"});
                $.each(deviceType.deviceProperties, function (idx, el) {
                    if (el.baseType == "LIST") {
                        propsList.push({id: el.id, name: el.name});
                    }
                });
                renderUISelectValues("selParentProp", propsList);
            }

            $scope.buildSemanticTypesSelect = function () {
                //console.log("semanticPropertyTypes0", $scope.shared.semanticPropertyTypes);
                if (!$scope.shared.semanticPropertyTypes) {
                    var url = $scope.deviceTypePropsAPI + "/semantic-types";
                    invokeGET($scope.http, url,
                            function (data, status, headers, config) {
                                $scope.shared.semanticPropertyTypes = data.result;
                                //console.log("semanticPropertyTypes1", $scope.shared.semanticPropertyTypes);
                            }
                    );
                }
            };

            $scope.unselectProperty = function () {
                $scope.$apply(function () {
                    $scope.selectedProperty = null;
                });
                eventBus.publish("change.SelectedProperty");
            };

            $scope.deleteDeviceTypeProp = function () {
                var selection = $scope.selectedProperty;
                if (!selection) return;

                arrayRemove($scope.shared.selectedDeviceType.deviceProperties, selection);

                var url = $scope.deviceTypesAPI + "/" + $scope.shared.selectedDeviceType.id + "/properties/" + selection.id;
                invokeDELETE($scope.http, url,
                        function (data, status, headers, config) {
                            $scope.buildPropsTable($scope.shared.selectedDeviceType);
                            $scope.buildParentPropsSelect($scope.shared.selectedDeviceType);

                            eventBus.publish("change.SelectedProperty");
                        }
                );
                $scope.unselectProperty();
            };

            $scope.addDeviceTypeProp = function () {
                if (!$scope.shared.selectedDeviceType) {
                    return;
                }

                var newProp = {
                    "name": "unnamed",
                    "baseType": "STRING"
                };

                var url = $scope.deviceTypesAPI + "/" +$scope.shared.selectedDeviceType.id + "/properties";
                invokePOST($scope.http, url, JSON.stringify(newProp),function (data, status, headers, config) {
                            var newEvent = {changedItem: $scope.shared.selectedDeviceType}
                            eventBus.publish("reload.DeviceTypeProps", newEvent);
                            $scope.shared.selectedDeviceType = null;
                            //$scope.buildPropsTable($scope.shared.selectedDeviceType);
                            //$scope.buildParentPropsSelect($scope.shared.selectedDeviceType);
                        }
                );

                $scope.unselectProperty();
            };

            $scope.saveDeviceTypeProp = function (devTypeProp) {
                if (!devTypeProp) {
                    devTypeProp = $scope.selectedProperty;
                }
                //console.log("before prepare", devTypeProp);
                $scope.prepareModelValues($scope.shared.selectedDeviceType);
                invokePUT($scope.http, $scope.deviceTypePropsAPI,
                        JSON.stringify(devTypeProp),
                        function (data, status, headers, config) {
                            $scope.buildPropsTable($scope.shared.selectedDeviceType);
                            $scope.buildParentPropsSelect($scope.shared.selectedDeviceType);
                            var event = {changedItem: $scope.shared.selectedDeviceType}
                            //console.log("change.DeviceTypeProps", event);
                            eventBus.publish("change.DeviceTypeProps", event);
                        }
                );

            };

            $scope.addPropDomainValue = function () {
                if (!$scope.selectedProperty.valueDomain.values)
                    $scope.selectedProperty.valueDomain.values = [];

                $scope.$apply(function () {
                    $scope.selectedProperty.valueDomain.values.push("");
                });
            };

            /* register event handlers*/
            $scope.addClickHandler("btnDeviceTypePropAdd", $scope.addDeviceTypeProp);
            $scope.addClickHandler("btnDeviceTypePropDelete", $scope.deleteDeviceTypeProp);
            $scope.addClickHandler("btnDeviceTypePropSave", function () {
                $scope.saveDeviceTypeProp($scope.selectedProperty);
            });
            $scope.addClickHandler("btnDeviceTypePropAddValue", $scope.addPropDomainValue);
            $scope.buildSemanticTypesSelect();
            $scope.onRenderElement("selDomainType", function (el) {
                el.on("change", function (newValue) {
                    $scope.$apply(function () {
                        if (!$scope.selectedProperty.valueDomain)
                            $scope.selectedProperty.valueDomain = {}
                        $scope.selectedProperty.valueDomain.type = newValue;
                    });
                });
            });

            $scope.subscribeOnce("change.SelectedProperty", function (event) {
                        /* adjust UI elements */
                        $("#btnDeviceTypePropDelete").attr("disabled",
                                $scope.selectedProperty == null);
                    }, "propSelectChangeListener"
            );

            $scope.$watch("shared.selectedDeviceType", function () {
                var devType = $scope.shared.selectedDeviceType;
                if (!devType) {
                    // delete existing container
                    destroyElement("DeviceTypePropsTable");
                    $scope.selectedProperty = null;
                } else {
                    $scope.buildPropsTable(devType);
                    $scope.buildParentPropsSelect(devType);
                }
                eventBus.publish("change.SelectedProperty");
            });

            /* start rendering the main container */
            renderElement("devicePropsSection");
        }
    ]);

</script>
