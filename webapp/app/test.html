
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>AngularJS + dojo Example:  - jsFiddle demo</title>
  
  <script type='text/javascript' src='//ajax.googleapis.com/ajax/libs/dojo/1.9.3/dojo/dojo.js'></script>
  
  <link rel="stylesheet" type="text/css" href="/css/normalize.css">
  
  
  <link rel="stylesheet" type="text/css" href="/css/result-light.css">
  
  <style type='text/css'>
    </style> <!-- Ugly Hack due to jsFiddle issue: http://goo.gl/BUfGZ --> <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"> <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.7.2/dijit/themes/claro/claro.css" />  
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
<!--<script src="https://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dojo/dojo.js"></script>-->

<script  type='text/javascript'>
angular.module('angular-dojo', []).directive('dojoWidget', function($timeout) {
    
    var parseProps = function(props, scope) {
        if (typeof props === 'undefined') return {};

    	props = '[{' + props + '}]';
        return eval(props)[0];
    };
    
    return {
        restrict: "A",
        replace: false,
        transclude: false,
        require: '?ngModel',
        scope: {
            'ngModel' : '=?',
            'ngClick' : '&',
            'ngChange' : '&',
            'dojoStore' : '&',
            'dojoProps' : '@',
            'dojoDisplayValue' : '=?'
        },
        link: function(scope, element, attrs, model) {
            require(["dojo/ready", "dijit/dijit", attrs.dojoWidget, "dojo/on"], function(ready, dijit, DojoWidget, on) {
          
                ready(function () {                
                    scope.widget = new DojoWidget({}, element[0]);
                    
                    attrs.$observe('dojoProps', function(dojoProps) {
                        scope.widget.set(parseProps(dojoProps, scope));
                    });
                    
                    attrs.$observe('dojoStore', function() {
                        if (scope.dojoStore != undefined) {
                            scope.widget.store = scope.dojoStore();     
                        }
                    });
                    
                    /*scope.$watch('ngModel', function() {
                        if (scope.ngModel != undefined) {
                        	if (attrs.dojoWidget == 'dijit/form/FilteringSelect' || attrs.dojoWidget == 'dijit/form/Select') {
                        		scope.widget.set('item', scope.ngModel);
                        	}
                        	else {
                        		scope.widget.set('value', scope.ngModel);
                                scope.widget.set('checked', scope.ngModel);
                        	}
                        }
                    });*/
                    
                    on(scope.widget, "blur", function () {
                        if (scope.widget.displayedValue != undefined) {
                            scope.dojoDisplayValue = scope.widget.displayedValue;
                        }
                    });

                    on(scope.widget, "change", function(newValue) {
                    	if (attrs.dojoWidget == 'dijit/form/FilteringSelect' || attrs.dojoWidget == 'dijit/form/Select') {
                    		scope.ngModel = this.item;
                    	}
                    	else {
                     		scope.ngModel = newValue;
                    	}
                    	                        
                        $timeout(function() {
                            scope.$apply();
                            if (scope.ngChange != undefined) {
                                scope.ngChange();
                            }
                        });
                    });

                    on(scope.widget, 'click', function() {
                        $timeout(function() {
                            scope.$apply();
                            if (scope.ngClick != undefined) {
                                scope.ngClick();
                            }
                        });
                    });
                });
            });
        }
    };
});
</script> 

<script type='text/javascript'>//<![CDATA[ 
require({
    packages: [
        {
            name: 'dojo',
            location: 'https://ajax.googleapis.com/ajax/libs/dojo/1.10.0/dojo/',
            main:'dojo/main' 
        }
    ]
});

angular.module('dojoTest', ['angular-dojo']);
//]]>  

</script>


</head>
<body>
  <div class="claro" data-ng-app="dojoTest">
    <div>
        <div data-dojo-widget="dijit/Calendar" id="calendar" data-ng-model="date" />
        <hr>
    </div>
     <h1>Selected: {{date | date:'medium' }}</h1>

</div>
  
</body>


</html>

