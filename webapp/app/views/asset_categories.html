
<section ng-controller="AssetCategoryController" id="AssetCategoryCont" style="height: 100%">

	<link rel="stylesheet" href="/bower_components/dijit/themes/claro/claro.css"/>
	<link rel="stylesheet" href="/bower_components/dgrid/css/skins/claro.css"/>

	<div style="margin:20px 0;">
		<button class="easyui-linkbutton" onclick="$(this).scope().assetCategoryAdd()">Add</button>
		<button class="easyui-linkbutton" onclick="$(this).scope().assetCategorySave()">Save</button>
		<button class="easyui-linkbutton" onclick="$(this).scope().assetCategoryCancel()">Revert</button>
	</div>

	<div id="assetCategoryTree"></div>

</section>

<script type="text/javascript">

	app = angular.module("app");
	app.controller('AssetCategoryController',
		function($scope) {

			convertNode = function(node, flat) {
				node = JSON.parse(JSON.stringify(node));
				var res = node;
				return JSON.parse(JSON.stringify(res));
			}

			categorySelected = null;
			$scope.assetCategoryLoadAll = function() {
				invokeGET($scope.http, $scope.categoriesAPI,
					function(data, status, headers, config) {
						var nodes = [];
						var i = 0;
						for(i = 0; i < data.result.length; i ++) {
							var obj = data.result[i];
							var e = convertNode(obj, true);
							nodes.push(e);
						};
						columnsConfig = [
							{label: "Name", field: "name", sortable: true, editOn: "dblclick", tree: true},
							{label: "Creator", field: "creator"},
							{label: "UUID", field: "uuid"}
						];
						displayDojoTable(nodes, "assetCategoryTree", columnsConfig);
					}
				);
			}
			$scope.assetCategoryLoadAll();

			$scope.assetCategoryEdit = function(){
				if (categorySelected != undefined){
					$('#tg').treegrid('select', categorySelected);
					return;
				}
				var row = $('#tg').treegrid('getSelected');
				if (row){
					categorySelected = row.id
					$('#tg').treegrid('beginEdit', categorySelected);
				}
			}
			$scope.assetCategorySave = function(){
				if (categorySelected != undefined){
					var t = $('#tg');
					t.treegrid('endEdit', categorySelected);
					categorySelected = undefined;
					var persons = 0;
					var rows = t.treegrid('getChildren');
					for(var i=0; i<rows.length; i++){
						var p = parseInt(rows[i].persons);
						if (!isNaN(p)){
							persons += p;
						}
					}
					var frow = t.treegrid('getFooterRows')[0];
					frow.persons = persons;
					t.treegrid('reloadFooter');
				}
			}
			$scope.assetCategoryCancel = function(){
				if (categorySelected != undefined){
					$('#tg').treegrid('cancelEdit', categorySelected);
					categorySelected = undefined;
				}
			}
			$scope.assetCategoryAdd = function(){
				alert("hi");
				if (categorySelected != undefined){
					$('#tg').treegrid('cancelEdit', categorySelected);
					categorySelected = undefined;
				}
			}
		}
	);

</script>
